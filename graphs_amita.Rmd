---
title: "Graphs for Amita's paper - trials inverting the zscore and recalculating qValue"
author: "Karen Cristine Goncalves dos Santos"
date: "4/8/2020"
fontsize: 12pt
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      root.dir = "E:/amita")
library(limma)
library(edgeR)
library(magrittr)
library(tidyverse)

```

# Using same qValue and just transforming the zscore ratio

I tried transforming the zscore ratio with this formula: $$log_2( {1 / (2 ^ {OZR})} )$$

where _OZR_ is the orignal $log_2$ zscore ratio. There problem is that I got no proteins deregulated for 3 of the 4 comparisons. So for the following graph, I transformed the _OZR_ like this: $$-1 * OZR$$
```{r Load data, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
normalized_abundances <- read.delim("normalized_abundances.txt", header = T, stringsAsFactors = F)
normalized_abundances$gene_name <- gsub(".*GN=(\\w+).*", "\\1", normalized_abundances$Description)

proteins_count <- data.frame(normalized_abundances[,3:14] %>% log2(), row.names = normalized_abundances$Accession)
design_table <- data.frame(Sample = c(rep("Control", 3), rep("IFN", 3), rep("Virus", 3), rep("IFN_Virus", 3)),
                           Replicates = colnames(normalized_abundances)[3:14])

design_table$Sample <- relevel(design_table$Sample, "Control") 
design <- model.matrix(~ 0+design_table$Sample)
colnames(design) <- unique(as.character(design_table$Sample))

contrast.matrix <- makeContrasts(IFN - Control, Virus - Control, 
                                 IFN_Virus - Control, IFN_Virus - Virus, 
                                 IFN_Virus - IFN, levels = design)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
org.adj.pVal <- read.delim("adjpval.txt", header = T, stringsAsFactors = F,  row.names = 1)
for (i in names(org.adj.pVal)) {
  org.adj.pVal[, i] <- ifelse(is.na(org.adj.pVal[, i]), 1, org.adj.pVal[, i])
}

zscore_ratios_log2 <- read.delim("zscore_ratios_log2.txt", header = T, stringsAsFactors = F)
zscores_correct_ratio_log2 <- -1 * zscore_ratios_log2[, 3:8]
rownames(zscores_correct_ratio_log2) <- zscore_ratios_log2$Accession
colnames(zscores_correct_ratio_log2) <- c("IFN.Control", "Virus.Control", 
                                          "IFN_Virus.Control", "Virus.IFN",
                                          "IFN_Virus.IFN", "IFN_Virus.Virus")


Total <- Down_regulated <- Up_regulated <- c()
org.combine <- org.filtered_results <- list()

for (i in contrast.matrix[1,] %>% names()) {
  a <- gsub(" - ", "\\.", i)
  org.combine[[i]] <- data.frame(Zscore_ratio = zscores_correct_ratio_log2[, a], 
                                 qValue = org.adj.pVal[rownames(zscores_correct_ratio_log2), a], 
                                 row.names = rownames(zscores_correct_ratio_log2))
  
  org.filtered_results[[i]] <- org.combine[[i]][abs(org.combine[[i]]$Zscore_ratio) > 1.96 &
                                                  org.combine[[i]]$qValue < 0.05, ]
  
  Down_regulated <- c(Down_regulated, length(org.filtered_results[[i]][which(org.filtered_results[[i]]$Zscore_ratio < 0), 1]))
  Up_regulated <- c(Up_regulated, length(org.filtered_results[[i]][which(org.filtered_results[[i]]$Zscore_ratio > 0), 1]))
  Total <-  c(Total, nrow(org.filtered_results[[i]]))
  
}

names(Up_regulated) <- names(Down_regulated) <- names(Total) <- contrast.matrix[1,] %>% names()
```
```{r, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
summary_table <- data.frame(Comparison = org.combine %>% names(),
                            Total = Total,
                            Down_regulated = Down_regulated,
                            Up_regulated = Up_regulated)
plot_summary <- reshape2::melt(summary_table, id = "Comparison")

ggplot(plot_summary, aes(Comparison, value, fill = variable, color = variable)) +
  geom_col(position = "dodge") + 
  geom_text(aes( label = value, y = value + 20), position = position_dodge(0.9), color = "black") + 
  scale_color_manual(name = "", values = c("grey", "blue", "red"))  +
  scale_fill_manual(name = "", values = c("grey", "blue", "red")) + 
  labs(y = "Number of variant proteins", x = "Comparison") + 
  theme_bw() + theme(axis.text.x = element_text(angle = 90, color = "black"))

```



# Re-calculating qvalue

For the two following graphs, I $log_2$-transformed the normalized abundances and used those to calculate the qvalue (with the following sequence of "limma" functions: "lmFit", "contrasts.fit", "eBayes" and "topTable" - this last one using adjust.method = "BH")

## Re-calculating zscore ratio

I calculated the zscore with the formula: $$zscore = (X - MEAN) / STDEV$$

Where X is the average abundance of each protein in a sample, MEAN and STDEV are the average and the standard deviation, respectively, of the abundance of each protein accross the experiment. 

I calculated the ratios and then I did the filtering that the people from U Laval did $$|log_2(zScore Ratio)| > 1.96 \cap qValue < 0.05$$

```{r Calculate scores, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
zscore_ <- list()
mean_ <- apply(proteins_count, 1, mean)
stdev <- apply(proteins_count, 1, sd)

for (i in levels(design_table$Sample)) {
  zscore_[[i]] <- (apply(proteins_count[, design_table$Replicates[design_table$Sample == i]],
                        1, mean) - mean_) / stdev
}

zscore_ratio <- data.frame(IFN.Control = zscore_$IFN/zscore_$Control %>% log2(), 
                           Virus.Control = zscore_$Virus/zscore_$Control %>% log2(), 
                           IFN_Virus.Control = zscore_$IFN_Virus/zscore_$Control %>% log2(), 
                           IFN_Virus.Virus = zscore_$IFN_Virus/zscore_$Virus %>% log2(),  
                           IFN_Virus.IFN = zscore_$IFN_Virus/zscore_$IFN %>% log2())

fit <- lmFit(proteins_count, design)
fit <- contrasts.fit(fit, contrast.matrix)
fit <- eBayes(fit)
results <- combined_results <- filtered_results <- list()
Down_regulated <- Up_regulated <- Total <- c()

for (i in contrast.matrix[1,] %>% names()) {
  a <- gsub(" - ", "\\.", i)
  results[[i]] <- topTable(fit, number = 4848, adjust.method = "BH", coef = i)
  combined_results[[i]] <- data.frame(Zscore_ratio = zscore_ratio[, a], 
                                      qValue = results[[i]][rownames(zscore_ratio), "adj.P.Val"])
  combined_results[[i]] <-  combined_results[[i]][!is.nan(combined_results[[i]]$Zscore_ratio), ]
  filtered_results[[i]] <- filter(combined_results[[i]],  abs(Zscore_ratio) > 1.96 & qValue < 0.05)
  
  Down_regulated <- c(Down_regulated, length(filtered_results[[i]][which(filtered_results[[i]]$Zscore_ratio < 0), 1]))
  Up_regulated <- c(Up_regulated, length(filtered_results[[i]][which(filtered_results[[i]]$Zscore_ratio > 0), 1]))
  Total <-  c(Total, nrow(filtered_results[[i]]))
}
  
names(Up_regulated) <- names(Down_regulated) <- names(Total) <- contrast.matrix[1,] %>% names()

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
summary_table <- data.frame(Comparison = combined_results %>% names(),
                            Total = Total,
                            Down_regulated = Down_regulated,
                            Up_regulated = Up_regulated)
plot_summary <- reshape2::melt(summary_table, id = "Comparison")

ggplot(plot_summary, aes(Comparison, value, fill = variable, color = variable)) +
  geom_col(position = "dodge") + 
  geom_text(aes( label = value, y = value +30), position = position_dodge(0.9), color = "black") + 
  scale_color_manual(name = "", values = c("grey", "blue", "red"))  +
  scale_fill_manual(name = "", values = c("grey", "blue", "red")) + 
  labs(y = "Number of variant proteins", x = "Comparison") + 
  theme_bw() + theme(axis.text.x = element_text(angle = 90, color = "black"))

```

## Transforming the zscore ratio from ULaval

Here I took the $log_2$ transformed zscore ratios from the excel sheet, de-transformed the values, inverted them and re-transformed to $log_2$: $$log_2(1 / (2 ^ {OZR}))$$

Then I did the filtering that the people from U Laval did: $$|log_2(zScore Ratio)| > 1.96 \cap qValue < 0.05$$


```{r, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
combined_results <- filtered_results <- list()

Down_regulated <- Up_regulated <- Total <- c()

for (i in contrast.matrix[1,] %>% names()) {
  a <- gsub(" - ", "\\.", i)
  combined_results[[i]] <- data.frame(Zscore_ratio = zscores_correct_ratio_log2[, a], 
                                      qValue = results[[i]][rownames(zscores_correct_ratio_log2), "adj.P.Val"])
  filtered_results[[i]] <- filter(combined_results[[i]], abs(Zscore_ratio) > 1.96 & qValue < 0.05)
  
  Down_regulated <- c(Down_regulated, length(filtered_results[[i]][which(filtered_results[[i]]$Zscore_ratio < 0), 1]))
  Up_regulated <- c(Up_regulated, length(filtered_results[[i]][which(filtered_results[[i]]$Zscore_ratio > 0), 1]))
  Total <-  c(Total, nrow(filtered_results[[i]]))
}

names(Up_regulated) <- names(Down_regulated) <- names(Total) <- contrast.matrix[1,] %>% names()

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
summary_table <- data.frame(Comparison = combined_results %>% names(),
                            Total = Total,
                            Down_regulated = Down_regulated,
                            Up_regulated = Up_regulated)
plot_summary <- reshape2::melt(summary_table, id = "Comparison")

ggplot(plot_summary, aes(Comparison, value, fill = variable, color = variable)) +
  geom_col(position = "dodge") + 
  geom_text(aes( label = value, y = value + 10), position = position_dodge(0.9), color = "black") + 
  scale_color_manual(name = "", values = c("grey", "blue", "red"))  +
  scale_fill_manual(name = "", values = c("grey", "blue", "red")) + 
  labs(y = "Number of variant proteins", x = "Comparison") + 
  theme_bw() + theme(axis.text.x = element_text(angle = 90, color = "black"))

```

# Overall

Basically I cannot get the same results either using the original zScore ratio and transforming with $log_2(1 / (2 ^ {OZR}))$ or with $-1 * OZR$ and using the original qValues, recalculating the qValue and transforming the original zscore or reca
