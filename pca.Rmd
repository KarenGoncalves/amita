---
title: "PCA of Amita's mass spectrometry results"
output:
  html_document:
    df_print: paged
---

<center> **Author:** Karen Cristine Goncalves dos Santos

**date:** `r Sys.Date()` </center>

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
library(readxl)

amita_final_all <- read_excel(
  "LF97_GermainH_20191015_Final results.xlsx", 
  sheet = "Final results all")

```

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
normalized_abundances <- 
  amita_final_all[, startsWith(colnames(amita_final_all), 
                               "Abundances (Normalized)")]
design <- data.frame(
  samples = c(rep("CTRL", 3), rep("IFN", 3), 
              rep("Virus", 3), rep("IFN_Virus", 3)),
  replicates = c(paste0("CTRL", 1:3), paste0("IFN", 1:3), 
                 paste0("Virus", 1:3), paste0("IFN_Virus", 1:3)))

colnames(normalized_abundances) <- design$replicates
```

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
pca <- prcomp(x = (normalized_abundances))

axes_importance <- as.data.frame(t(summary(pca)[6]$importance))
prcomponents <- paste0("P", 1:nrow(axes_importance))
axes_importance$Components <- factor(prcomponents, levels = prcomponents)

results_pca <- data.frame(design, pca[["rotation"]])
```

For this PCA, I considered all the proteins. I did not rescale the axes to the proportion of explanation because then the y-axis was really small.

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
library(ggplot2)

par(mfrow = c(2, 1))
ggplot(axes_importance, aes(Components, `Proportion of Variance` * 100)) +
  geom_point() + labs (x = "Components", y = "Proportion of variance explained (%)") +
  theme_bw()


ggplot(axes_importance, aes(Components, `Cumulative Proportion` * 100)) +
  geom_point() + labs (x = "Components", y = "Cumulative proportion of variance explained (%)") +
  theme_bw()

ggplot(results_pca, aes(PC1, PC2, color = samples)) +
  geom_point(size = 2) +
  labs(x = 
         paste0("PC1 (", (
           axes_importance$`Proportion of Variance`[1]*100), "%)"),
       y = paste0("PC2 (", (
         axes_importance$`Proportion of Variance`[2]*100), "%)")) +
  theme_bw() 
```


```{r message=FALSE, warning=FALSE, paged.print=TRUE}
covariance <- data.frame(Mean = apply(normalized_abundances, 1, mean), 
                         Std = apply(normalized_abundances, 1, sd))

covariance$covariance <- covariance$Std/covariance$Mean

filtered_abundances <- normalized_abundances[
  order(covariance$covariance, decreasing = T)[
    1:(nrow(normalized_abundances)/20)],]

pca_filtered <- prcomp(x = (filtered_abundances))

axes_importance_f <- as.data.frame(t(summary(pca_filtered)[6]$importance))

axes_importance_f <- as.data.frame(t(summary(pca_filtered)[6]$importance))
prcomponents <- paste0("P", 1:nrow(axes_importance_f))

axes_importance_f$Components <- factor(prcomponents, levels = prcomponents)

results_pca_f <- data.frame(design, pca_filtered[["rotation"]])
```

For this PCA, I considered the top 10% of the proteins with highest covariance (to simplify the dataset getting most of the variability with the minimum amount of proteins)

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
library(ggplot2)

par(mfrow = c(2, 1))
ggplot(axes_importance_f, aes(Components, `Proportion of Variance` * 100)) +
  geom_point() + labs (x = "Components", y = "Proportion of variance explained (%)") +
  theme_bw()


ggplot(axes_importance_f, aes(Components, `Cumulative Proportion` * 100)) +
  geom_point() + labs (x = "Components", y = "Cumulative proportion of variance explained (%)") +
  theme_bw()

ggplot(results_pca_f, aes(PC1, PC2, color = samples)) +
  geom_point(size = 2) +
  labs(x = 
         paste0("PC1 (", (
           axes_importance_f$`Proportion of Variance`[1]*100), "%)"),
       y = paste0("PC2 (", (
         axes_importance_f$`Proportion of Variance`[2]*100), "%)")) +
  theme_bw()# + theme(aspect.ratio = axes_importance_f$`Proportion of Variance`[2]/axes_importance_f$`Proportion of Variance`[1])
```

